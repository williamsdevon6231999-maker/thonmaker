trigger:
- main

pool:
  name: openvas-pool

variables:
  imageName: thonmaker
  acrName: thonmakeracr
  acrLoginServer: thonmakeracr.azurecr.io
  webAppName: thonmaker-app

  # Replace with your real App Service URL
  # Example: https://thonmaker-app-xxxx.eastus2-01.azurewebsites.net
  dastTargetUrl: "https://thonmaker-app-xxxx.eastus2-01.azurewebsites.net"

steps:
# ---------------------------
# SAST – Semgrep (FAIL on findings)
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    chcp 65001 | Out-Null
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep

    # Fail pipeline on ERROR-level findings
    semgrep scan --config=auto --severity=ERROR --error --metrics=off
  displayName: "SAST - Semgrep (Fail on ERROR)"

# ---------------------------
# Build Docker image
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    docker build -t $(imageName):$(Build.BuildId) .
  displayName: "Build Docker Image"

# ---------------------------
# Ensure Trivy exists
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    if (-not (Get-Command trivy -ErrorAction SilentlyContinue)) {
      winget install --id AquaSecurity.Trivy -e --accept-package-agreements --accept-source-agreements
    }
    trivy -v
  displayName: "Install / Verify Trivy"

# ---------------------------
# Trivy Image Scan (FAIL on HIGH/CRITICAL CVEs)
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    $env:TRIVY_CACHE_DIR = "$(Pipeline.Workspace)\trivy-cache"
    trivy image --severity HIGH,CRITICAL --exit-code 1 $(imageName):$(Build.BuildId)
  displayName: "Trivy (Fail on HIGH/CRITICAL)"

# ---------------------------
# Login to ACR
# ---------------------------
- task: AzureCLI@2
  displayName: "Login to ACR"
  inputs:
    azureSubscription: sc-thonmaker-azure
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az acr login --name $(acrName)

# ---------------------------
# Tag + Push image to ACR
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    docker tag $(imageName):$(Build.BuildId) $(acrLoginServer)/$(imageName):$(Build.BuildId)
    docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)
  displayName: "Push Image to ACR"

# ---------------------------
# Deploy to Azure Web App (Container)
# ---------------------------
- task: AzureWebAppContainer@1
  displayName: "Deploy to Azure App Service"
  inputs:
    azureSubscription: sc-thonmaker-azure
    appName: $(webAppName)
    imageName: $(acrLoginServer)/$(imageName):$(Build.BuildId)

# ---------------------------
# DAST – OpenVAS (runs AFTER deploy)
# FAIL if High/Critical are present
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"

    $uri = [System.Uri]"$(dastTargetUrl)"
    $targetHost = $uri.Host
    Write-Host "DAST Target: $($uri.AbsoluteUri)"
    Write-Host "Host: $targetHost"

    # Start OpenVAS stack (compose file lives in repo)
    docker compose -f openvas/docker-compose.yml up -d

    # NOTE: Full automation of OpenVAS (create target/task, run, parse report)
    # is doable but heavy on Windows self-hosted agents.
    # For now this verifies the DAST stack launches; then you can add the task/run gate next.

    docker ps
  displayName: "DAST - OpenVAS (Bring up stack)"
