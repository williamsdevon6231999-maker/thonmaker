trigger:
- main

pool:
  name: SelfHostedWindows

steps:
# --- SAST (Semgrep) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    chcp 65001 | Out-Null
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    $env:PYTHONUTF8 = "1"

    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep

    python -m semgrep scan --config=auto --sarif --output semgrep.sarif
  displayName: "SAST - Semgrep (SARIF)"

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: semgrep.sarif
    ArtifactName: sast-semgrep-sarif
  displayName: "Publish Semgrep SARIF"

# --- Build + Smoke Test ---
- powershell: |
    $ErrorActionPreference = "Stop"

    docker build -t thonmaker:$(Build.BuildId) .

    $exists = docker ps -a --format "{{.Names}}" | Select-String -SimpleMatch "thonmaker_test"
    if ($exists) { docker rm -f thonmaker_test | Out-Null }

    docker run -d --name thonmaker_test -p 8000:8000 thonmaker:$(Build.BuildId)

    for ($i=1; $i -le 15; $i++) {
      try {
        Invoke-WebRequest http://localhost:8000/ -UseBasicParsing -TimeoutSec 3 | Out-Null
        Write-Host "Smoke test passed"
        exit 0
      } catch {
        Write-Host "Waiting for app... attempt $i"
        Start-Sleep -Seconds 2
      }
    }

    Write-Host "Smoke test failed. Container logs:"
    docker logs thonmaker_test
    exit 1
  displayName: "Build and smoke test Docker container"
