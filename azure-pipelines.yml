trigger:
- main

pool:
  name: SelfHostedWindows

steps:
# --- SAST (Semgrep) ---
- powershell: |
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    python -m pip install --upgrade pip
    pip install semgrep
    semgrep scan --config=auto --error
  displayName: "SAST - Semgrep Scan"


# --- Build + Smoke Test ---
- powershell: |
    $ErrorActionPreference = "Stop"

    docker build -t thonmaker:$(Build.BuildId) .

    # Remove container if it exists (DON'T fail if it doesn't)
    docker rm -f thonmaker_test 2>$null
    $LASTEXITCODE = 0

    docker run -d --name thonmaker_test -p 8000:8000 thonmaker:$(Build.BuildId)

    for ($i=1; $i -le 15; $i++) {
      try {
        Invoke-WebRequest http://localhost:8000/ -UseBasicParsing -TimeoutSec 3 | Out-Null
        Write-Host "Smoke test passed"
        exit 0
      } catch {
        Write-Host "Waiting for app... attempt $i"
        Start-Sleep -Seconds 2
      }
    }

    Write-Host "Smoke test failed. Container logs:"
    docker logs thonmaker_test
    exit 1
  displayName: "Build and smoke test Docker container"
