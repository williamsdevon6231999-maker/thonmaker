trigger:
- main

pool:
  name: SelfHostedWindows

variables:
  imageName: thonmaker
  acrName: thonmakeracr
  acrLoginServer: thonmakeracr.azurecr.io
  webAppName: thonmaker-app

steps:
# ---------------------------
# SAST â€“ Semgrep (report only)
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep
    semgrep scan --config=auto
    $global:LASTEXITCODE = 0
  displayName: "SAST - Semgrep"

# ---------------------------
# Build Docker image
# ---------------------------
- powershell: |
    docker build -t $(imageName):$(Build.BuildId) .
  displayName: "Build Docker Image"

# ---------------------------
# Trivy Image Scan (report only)
# ---------------------------
- powershell: |
    trivy image --severity HIGH,CRITICAL $(imageName):$(Build.BuildId)
    $global:LASTEXITCODE = 0
  displayName: "Trivy Image Scan"

# ---------------------------
# Login to ACR
# ---------------------------
- task: Docker@2
  displayName: "Login to ACR"
  inputs:
    command: login
    containerRegistry: sc-thonmaker-acr

# ---------------------------
# Tag + Push image to ACR
# ---------------------------
- powershell: |
    docker tag $(imageName):$(Build.BuildId) $(acrLoginServer)/$(imageName):$(Build.BuildId)
    docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)
  displayName: "Push Image to ACR"

# ---------------------------
# Deploy to Azure Web App (Container)
# ---------------------------
- task: AzureWebAppContainer@1
  displayName: "Deploy to Azure App Service"
  inputs:
    azureSubscription: sc-thonmaker-azure
    appName: $(webAppName)
    imageName: $(acrLoginServer)/$(imageName):$(Build.BuildId)
