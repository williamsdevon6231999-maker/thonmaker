trigger:
- main

pool:
  name: SelfHostedWindows

steps:
# --- SAST (Semgrep) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    chcp 65001 | Out-Null
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    $env:PYTHONUTF8 = "1"
    $env:PYTHONIOENCODING = "utf-8"

    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep

    # Run SAST (report only â€“ do not fail pipeline)
    python -m semgrep scan --config=auto; $LASTEXITCODE = 0
  displayName: "SAST - Semgrep Scan"

# --- Build Docker image ---
- powershell: |
    $ErrorActionPreference = "Stop"
    docker build -t thonmaker:$(Build.BuildId) .
  displayName: "Build Docker image"

# --- Install / Verify Trivy ---
- powershell: |
    $ErrorActionPreference = "Stop"

    if (-not (Get-Command trivy -ErrorAction SilentlyContinue)) {
      if (Get-Command winget -ErrorAction SilentlyContinue) {
        winget install --id AquaSecurity.Trivy -e --accept-package-agreements --accept-source-agreements
      } else {
        Write-Host "ERROR: winget not found on this agent"
        exit 1
      }
    }

    trivy -v
  displayName: "Install / Verify Trivy"

# --- Image CVE Scan (report only) ---
- powershell: |
    $ErrorActionPreference = "Stop"
    $env:TRIVY_CACHE_DIR = "$(Pipeline.Workspace)\trivy-cache"
    trivy image --severity HIGH,CRITICAL thonmaker:$(Build.BuildId)
  displayName: "Image CVE Scan - Trivy"

# --- Smoke Test (with guaranteed cleanup) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    $name = "thonmaker_test_$(Build.BuildId)"
    $tag  = "thonmaker:$(Build.BuildId)"

    function Remove-Container([string]$n) {
      docker rm -f $n *> $null
      $global:LASTEXITCODE = 0
    }

    try {
      # cleanup if exists (never fail)
      Remove-Container $name

      # run container with random host port
      docker run -d --name $name -p 0:8000 $tag | Out-Null

      # discover assigned host port
      $portLine = docker port $name 8000/tcp
      $hostPort = ($portLine -split ':')[-1].Trim()

      for ($i=1; $i -le 20; $i++) {
        try {
          Invoke-WebRequest "http://localhost:$hostPort/" -UseBasicParsing -TimeoutSec 3 | Out-Null
          Write-Host "Smoke test passed on port $hostPort"
          exit 0
        } catch {
          Write-Host "Waiting for app... attempt $i (port $hostPort)"
          Start-Sleep -Seconds 2
        }
      }

      Write-Host "Smoke test failed. Container logs:"
      docker logs $name
      exit 1
    }
    finally {
      # ALWAYS cleanup (never fail)
      Remove-Container $name
    }
  displayName: "Smoke Test Docker Container"

