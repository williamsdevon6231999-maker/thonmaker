trigger:
- main

pool:
  name: SelfHostedWindows

steps:
# --- SAST (Semgrep) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    chcp 65001 | Out-Null
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    $env:PYTHONUTF8 = "1"
    $env:PYTHONIOENCODING = "utf-8"

    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep
    python -m semgrep scan --config=auto
  displayName: "SAST - Semgrep Scan"

# --- Build Docker image (so Trivy has something to scan) ---
- powershell: |
    $ErrorActionPreference = "Stop"
    docker build -t thonmaker:$(Build.BuildId) .
  displayName: "Build Docker image"

# --- Install/Verify Trivy (no Chocolatey required) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    if (-not (Get-Command trivy -ErrorAction SilentlyContinue)) {
      if (Get-Command winget -ErrorAction SilentlyContinue) {
        winget install --id AquaSecurity.Trivy -e --accept-package-agreements --accept-source-agreements
      } else {
        Write-Host "ERROR: 'winget' not found on this agent. Install Trivy manually or enable winget."
        exit 1
      }
    }

    trivy -v
  displayName: "Install/Verify Trivy"

# --- Trivy CVE Scan (report HIGH/CRITICAL) ---
- powershell: |
    $ErrorActionPreference = "Stop"
    $env:TRIVY_CACHE_DIR = "$(Pipeline.Workspace)\trivy-cache"
    trivy image --severity HIGH,CRITICAL thonmaker:$(Build.BuildId)
  displayName: "Vuln Scan - Trivy (HIGH/CRITICAL)"

# --- Smoke Test (with guaranteed cleanup) ---
- powershell: |
    $ErrorActionPreference = "Stop"

    $name = "thonmaker_test"
    $port = 8000
    $tag  = "thonmaker:$(Build.BuildId)"

    try {
      docker rm -f $name 2>$null
      $LASTEXITCODE = 0

      docker run -d --name $name -p ${port}:${port} $tag | Out-Null

      for ($i=1; $i -le 15; $i++) {
        try {
          Invoke-WebRequest "http://localhost:$port/" -UseBasicParsing -TimeoutSec 3 | Out-Null
          Write-Host "Smoke test passed"
          exit 0
        } catch {
          Write-Host "Waiting for app... attempt $i"
          Start-Sleep -Seconds 2
        }
      }

      Write-Host "Smoke test failed. Container logs:"
      docker logs $name
      exit 1
    }
    finally {
      docker rm -f $name 2>$null
      $LASTEXITCODE = 0
    }
  displayName: "Smoke test Docker container"
